---
title: "An谩lisis personalizados"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

A continuaci贸n se describe un conjunto b谩sico de instrucciones para usar
`sivirep` si:

-   Ya has producido un archivo .Rmd y deseas editar un reporte.
-   Deseas realizar an谩lisis personalizados sin un archivo .Rmd.

### Configuraci贸n

Puedes comenzar importando el paquete a trav茅s del siguiente comando:

```{r import-sivirep}
library(sivirep)
```

### 1. Importaci贸n de datos de SIVIGILA

La fuente de SIVIGILA proporciona los datos de la lista de casos
hist贸ricos hasta el 煤ltimo a帽o epidemiol贸gico cerrado. El cierre de un
a帽o epidemiol贸gico generalmente ocurre en abril del siguiente a帽o (por
ejemplo, si est谩s utilizando `sivirep` en marzo de 2023, es posible que
puedas acceder a los datos hist贸ricos hasta diciembre de 2021) para la
mayor铆a de las enfermedades, con algunas excepciones.

Por favor, verifica las enfermedades y a帽os disponibles utilizando:

```{r eventos, results = 'hide'}
lista_eventos <- list_events()
```

Una vez que hayas decidido la enfermedad y el a帽o de la cual deseas
obtener la informaci贸n, `import_data_event` es la funci贸n que permite la
importaci贸n de datos desde la fuente de SIVIGILA utilizando un formato
parametrizado basado en la enfermedad y el a帽o.

```{r import-data-event}
data_event <- import_data_event(
  nombre_event = "Dengue",
  years = 2020,
  cache = TRUE
)
```

> **Tip 1 - Evita retrasos de tiempo al importar datos** <br/>
   `sivirep` est谩 dise帽ado para ayudar con el acceso a la fuente SIVIGILA.
    El proceso de descarga de informaci贸n sobre enfermedades puede tomar varios 
    minutos dependiendo del tama帽o del conjunto de datos. Para evitar volver a 
    descargar los mismos datos cada vez, puedes utilizar el par谩metro 
    `cache = TRUE` en la funci贸n `import_data_event`.

> **Tip 2 - Descarga datos de enfermedades para m煤ltiples a帽os** <br/>
    Con la funci贸n `import_data_event`, es posible descargar datos para 
    m煤ltiples a帽os. Por ejemplo, si deseas descargar datos de 3 a帽os de una 
    enfermedad en particular, puedes usar el par谩metro `year` de la siguiente 
    manera:
   `import_data_event(data_event = "dengue", years = c(2021, 2019, 2018), cache = TRUE)`
    Tambi茅n puedes especificar a帽os no consecutivos:
   `import_data_event(data_event = "dengue", years = c(2024, 2018, 2013), cache = TRUE)`

### 2. Limpieza de datos de SIVIGILA

Los datos de SIVIGILA son una fuente de informaci贸n oficial altamente
confiable, con certificaci贸n ISO de calidad de datos. Sin embargo, a
veces puede haber algunos valores at铆picos en los datos que requieran
una limpieza adicional.

`sivirep` proporciona una funci贸n gen茅rica llamada
`limpiar_data_sivigila` que envuelve diversas tareas para identificar y
corregir errores, inconsistencias y discrepancias en los conjuntos de
datos con el fin de mejorar su calidad y precisi贸n. Este proceso puede
incluir la eliminaci贸n de duplicados, la correcci贸n de errores
tipogr谩ficos, el reemplazo de valores faltantes y la validaci贸n de
datos, entre otras tareas, como eliminar fechas improbables, limpiar
c贸digos de geolocalizaci贸n y estandarizar los nombres de las columnas y
las categor铆as de edad.

```{r limpiar-data-sivigila}
data_event_limpia <- limpiar_data_sivigila(data_event = data_event)
```

Las funciones de limpieza dentro de `limpiar_data_sivigila` se han
recopilado y creado en base a la experiencia de epidemi贸logos de campo.

Estas pueden incluir funciones internas como:

-   `limpiar_columnas_event`: funci贸n que limpia y estandariza los nombres de 
     columnas de los datos del SIVIGILA.
-   `limpiar_edad_event`: funci贸n que limpia y estandariza las edades a a帽os, 
     seg煤n la clasificaci贸n del INS.
-   `limpiar_val_atipic`: funci贸n que limpia valores at铆picos de los datos de 
     enfermedades.
-   `limpiar_fecha_event`: funci贸n que limpia y estandariza fechas de los datos 
     de enfermedades.
-   `estandarizar_geo_cods`: funci贸n que estandariza los c贸digos geogr谩ficos,
     seg煤n la codificaci贸n DIVIPOLA.
-   `convert_edad`: funci贸n que convierte edades a a帽os seg煤n las unidades de 
     medida del SIVIGILA.

Puedes utilizar estas funciones individualmente o simplemente usar la funci贸n 
gen茅rica de limpieza.

### 3. Filtrar casos

`sivirep` proporciona una funci贸n que permite filtrar los datos de
enfermedades por departamento o nombre del municipio llamada
`geo_filtro`. Esto permite al usuario crear un informe a nivel
subnacional, seleccionando casos espec铆ficos basados en la ubicaci贸n
geogr谩fica.

```{r geo-filtro}
data_event_filtrada <- geo_filtro(
  data_event = data_event_limpia,
  dpto = "Choco"
)
```

### 4. Distribuci贸n temporal de casos

En `sivirep`, la distribuci贸n temporal de casos se define por las
variables de fecha de inicio de s铆ntomas y fecha de notificaci贸n. Para
cada una de estas variables, existen funciones especializadas para
agrupar los datos y generar los gr谩ficos.

#### 4.1. Agrupar los datos por fecha de inicio de s铆ntomas en la escala temporal deseada

Para generar la distribuci贸n de casos por fecha de inicio de s铆ntomas,
es necesario agrupar los datos por estas variables. `sivirep`
proporciona una funci贸n que permite esta agrupaci贸n llamada
`agrupar_fecha_inisintomas`.

```{r agrupar-fecha-inicio-sintomas}
casos_ini_sintomas <- agrupar_fecha_inisintomas(
  data_event = data_event_limpia
)
```

>  **Tip**: Obt茅n los primeros n meses con m谩s casos
>
> Al construir una secci贸n del reporte o analizar estos datos, puede
  ser 煤til obtener los meses con m谩s casos. En `sivirep`, puedes
  utilizar la funci贸n `obtener_meses_mas_casos` para obtener esta
  informaci贸n.

El gr谩fico que permite visualizar esta distribuci贸n se debe generar con
la funci贸n `plot_fecha_inisintomas`. Ten en cuenta que, incluso si has
agrupado los datos por d铆a, es posible que prefieras representarlo por
semana epidemiol贸gica, como en:

```{r plot-fecha-inicio-sintomas, fig.height = 4, fig.width = 8}
plot_fecha_inisintomas(
  data_agrupada = casos_ini_sintomas,
  uni_marca = "semanaepi"
)
```

### 5. Edad y sexo

### 5.1. Variable de sexo

Cuando se analizan o se informan datos de enfermedades, a menudo es
necesario determinar la distribuci贸n de casos por g茅nero o sexo. Sin
embargo, la fuente de SIVIGILA solo registra el sexo.

`sivirep` proporciona una funci贸n que agrega y calcula autom谩ticamente
los porcentajes por sexo despu茅s del proceso de limpieza.

```{r agrupar-sexo}
casos_sex <- agrupar_sex(
  data_event = data_event_limpia,
  porcentaje = TRUE
)
```

Adem谩s, `sivirep` cuenta con una funci贸n para generar el gr谩fico por
esta variable llamada `plot_sex`:

```{r plot-sexo, fig.height = 5, fig.width = 7}
plot_sex(data_agrupada = casos_sex)
```

La distribuci贸n de casos por sexo y semana epidemiol贸gica se puede
generar utilizando la funci贸n `agrupar_sex_semanaepi` proporcionada por
`sivirep`.

```{r agrupar-sex-semana-epidemiologica}
casos_sex_semanaepi <- agrupar_sex_semanaepi(data_event = data_event_limpia)
```

La funci贸n de visualizaci贸n correspondiente es `plot_sex_semanaepi`, que
`sivirep` proporciona para mostrar la distribuci贸n de casos por sexo y
semana epidemiol贸gica.

```{r plot-sex-semana-epidemiologica, fig.height = 7, fig.width = 8}
plot_sex_semanaepi(data_agrupada = casos_sex_semanaepi)
```

### 5.2. Variable de edad

La edad es una variable importante para analizar, ya que es un factor de
riesgo conocido para muchas enfermedades. Ciertas enfermedades y
condiciones tienden a ocurrir con m谩s frecuencia en grupos de edad
espec铆ficos, y esta distribuci贸n puede ayudar a identificar poblaciones
con mayor riesgo e implementar estrategias de prevenci贸n y control
dirigidas.

`sivirep` proporciona una funci贸n llamada `agrupar_edad`, que puede
agrupar los datos de enfermedades por grupos de edad. De forma
predeterminada, esta funci贸n produce rangos de edad con intervalos de 10
a帽os. Adem谩s, los usuarios pueden personalizar un rango de edad
diferente.

```{r agrupar-edad}
casos_edad <- agrupar_edad(data_event = data_event_limpia, interval_edad = 10)
```

La funci贸n de visualizaci贸n correspondiente es `plot_edad`.

```{r plot-edad, fig.height = 3, fig.width = 6}
plot_edad(data_agrupada = casos_edad)
```

### 5.3. Edad y sexo simult谩neamente

`sivirep` proporciona una funci贸n llamada `agrupar_edad_sex`, que puede
agrupar los datos de enfermedades por rangos de edad y sexo de forma
simult谩nea y obtener el n煤mero de casos y los porcentajes
correspondientes. Adem谩s, permite personalizar el intervalo de edad.

```{r agrupar-edad-sexo}
casos_edad_sex <- agrupar_edad_sex(
  data_event = data_event_limpia,
  interval_edad = 10
)
```

La funci贸n de visualizaci贸n correspondiente es `plot_edad_sex`.

```{r plot-edad-sexo, fig.height = 3, fig.width = 6}
plot_edad_sex(data_agrupada = casos_edad_sex)
```

### 6. Distribuci贸n espacial de casos

Obtener la distribuci贸n espacial de los casos es 煤til para identificar
谩reas con una alta concentraci贸n de casos, agrupaciones de enfermedades
y factores de riesgo ambientales o sociales.

En Colombia, existen 32 unidades geogr谩ficas administrativas (adm1)
llamadas departamentos. 

`sivirep` proporciona una funci贸n llamada `agrupar_mpio` que te permite obtener 
datos de enfermedades agrupados por municipios de un departamento espec铆fico

```{r agrupar-municipios}
dist_esp_mpio <- agrupar_mpio(
  data_event = data_event_filtrada,
  dpto = "Choco"
)
```

Tambi茅n existe una funci贸n para obtener la distribuci贸n de casos en todos los 
departamentos de Colombia, llamada `agrupar_dpto`:

```{r group-dpto}
dist_esp_dpto <- agrupar_dpto(data_event = data_event_limpia)
```

Actualmente, con la funci贸n llamada `plot_map`, el usuario puede generar
un mapa est谩tico de Colombia que muestra la distribuci贸n de casos por
departamentos y municipios.

> **Tip - Evita retrasos al generar el mapa** <br/>
 Es necesario descargar los archivos shapefiles de Colombia para generar el 
 mapa. Para evitar volver a descargarlos cada vez que lo quieras generar, puedes 
 utilizar el par谩metro `cache = TRUE` en la funci贸n `plot_map`.

```{r plot-mapa, echo = TRUE, error = FALSE, warning = FALSE, include = FALSE, message = FALSE, fig.height = 14, fig.width = 10}
mapa <- plot_map(
  data_agrupada = dist_esp_mpio, dpto = "Choco",
  col_distribucion = "casos",
  cache = TRUE
)
mapa
```

>  **Tip**: Obtener la fila con mayor n煤mero de casos
> Al construir una secci贸n del reporte o analizar estos datos, puede ser 煤til   
  saber cu谩l es la variable que tiene la mayor铆a de los casos. En `sivirep`, 
  puedes utilizar la funci贸n `obtener_fila_mas_casos` para obtener esta  
  informaci贸n. Esta funci贸n funciona con cualquier conjunto de datos que  
  contenga una columna llamada `"casos"` en cualquier nivel de agregaci贸n.

### 7. Incidencia

Con `sivirep`, puedes calcular tasas de incidencia por geograf铆a o sexo 
utilizando las proyecciones poblacionales del DANE o la poblaci贸n a riesgo, 
dependiendo de la enfermedad y la disponibilidad de los datos.

>  **Nota:** `sivirep` no incluye datos de poblaci贸n a riesgo para todos los 
  eventos o enfermedades. Sin embargo, si tienes esta informaci贸n, puedes 
  proporcionarla usando el par谩metro `data_incidencia` en cada funci贸n.

#### 7.1 Incidencia por geograf铆a

Puedes calcular la incidencia por los departamentos de Colombia o por los 
municipios de un departamento espec铆fico, utilizando la funci贸n 
`calcular_incidencia_geo`:

```{r incidence-muns, echo = FALSE, error = FALSE, warning = FALSE, include = TRUE, message = FALSE}
incidencia_muns <-
     calcular_incidencia_geo(data_agrupada = dist_esp_mpio,
                             ruta_dir = tempdir())
```

##### 7.1.1 Mapa de incidencia por geograf铆a

Con la funci贸n `plot_map` puedes visualizar y generar un mapa con las 
incidencias a nivel naciona, para un departamento o municipio espec铆fico, 
dependiendo de tus par谩metros y los c谩lculos realizados.

```{r plot-map-incidence, fig.height = 7, fig.width = 7}
mapa <- plot_map(data_agrupada = incidencia_muns$data_incidencia,
                 ruta_dir = tempdir())
mapa
```

#### 7.2 Incidencia por sexo

`sivirep` proporciona una funci贸n llamada `calcular_incidencia_sex` que te 
permite calcular la incidencia por sexo a nivel nacional (Colombia), o para un 
departamento o municipio espec铆fico.

```{r incidence-sex, echo = FALSE, error = FALSE, warning = FALSE, include = TRUE, message = FALSE}
incidencia_sex <-  calcular_incidencia_sex(
   data_agrupada = casos_sex,
   dpto = "Choco",
   ruta_dir = tempdir()
 )
```

#### 7.3 Incidencia total en el pa铆s

La funci贸n `calcular_incidencia` te permite calcular la incidencia para todo 
el pa铆s:

```{r total-incidence, echo = FALSE, error = FALSE, warning = FALSE, include = TRUE, message = FALSE}
incidencia_total <-
     calcular_incidencia(data_agrupada = data_event_limpia,
                         ruta_dir = tempdir())
```
