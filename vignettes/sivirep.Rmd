---
title: "sivirep"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sivirep}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  include = TRUE,
  error = FALSE,
  warning = FALSE,
  message = FALSE
)
```

```{r setup}
library(sivirep)
```

## Descripci贸n

La versi贸n actual de *sivirep* 0.0.2 proporciona funciones para la manipulaci贸n de datos y la generaci贸n de reportes automatizados basados en las bases de datos individualizadas de casos de
[SIVIGILA](https://www.ins.gov.co/Direcciones/Vigilancia/Paginas/SIVIGILA.aspx),
que es el sistema oficial de vigilancia epidemiol贸gica de Colombia.

## Motivaci贸n

Am茅rica Latina ha progresado en la calidad de sus sistemas de notificaci贸n y vigilancia epidemiol贸gica. En particular, Colombia ha mejorado a lo largo de los a帽os la calidad, la accesibilidad y la transparencia de su sistema oficial de vigilancia epidemiol贸gica, [SIVIGILA](https://www.ins.gov.co/Direcciones/Vigilancia/Paginas/SIVIGILA.aspx). Este sistema est谩 regulado por el [Instituto Nacional de Salud](https://www.ins.gov.co) de Colombia y es operado por miles de trabajadores de la salud en las secretar铆as de salud locales, hospitales y unidades primarias generadoras de datos.

Sin embargo, todav铆a existen desaf铆os, especialmente a nivel local, en cuanto a la oportunidad y la calidad del an谩lisis epidemiol贸gico y de los informes epidemiol贸gicos. Estas tareas pueden requerir una gran cantidad de trabajo manual debido a limitaciones en el entrenamiento para el an谩lisis de datos, el tiempo que se requiere invertir, la tecnolog铆a y la calidad del acceso a internet en algunas regiones de Colombia.

El objetivo de `sivirep` es proporcionar un conjunto de herramientas para:

1) Descargar, preprocesar y preparar los datos de SIVIGILA para su posterior an谩lisis.
2) Generar informes epidemiol贸gicos automatizados adaptables al contexto.
3) Proporcionar retroalimentaci贸n sobre el sistema de vigilancia al proveedor de la fuente de datos.

## Potenciales usuarios

- Profesionales de salud p煤blica y de epidemiolog铆a de campo que utilizan la fuente de datos de SIVIGILA a nivel local.
- Estudiantes de epidemiolog铆a y salud p煤blica.
- Investigadores y analistas de datos a nivel nacional e internacional.

## Inicio r谩pido

Puedes revisar las enfermedades y los a帽os disponibles de forma libre utilizando:

```{r}
lista_eventos <- list_events()
knitr::kable(lista_eventos)
```

## Versiones futuras

Las versiones futuras de `sivirep` podr铆an incluir:

- Interacci贸n con otras fuentes de datos en Colombia.
- Otros sistemas de vigilancia epidemiol贸gica en Am茅rica Latina.

## Contribuciones

Las contribuciones son bienvenidas via [pull requests](https://github.com/epiverse-trace/sivirep/pulls).

Los contribuyentes al paquete incluyen:

-   [Geraldine G贸mez-Mill谩n](https://github.com/GeraldineGomez) (author)

-   [Zulma M. Cucunub谩](https://github.com/zmcucunuba) (author)

-   [Hugo Gruson](https://github.com/Bisaloo) (contributor)

-   Laura G贸mez-Bermeo (contributor to documentation)

-   Miguel G谩mez (contributor)

## C贸digo de conducta

Por favor, ten en cuenta que el proyecto `sivirep` se publica con un
[C贸digo de Conducta para Contribuyentes](https://contributor-covenant.org/version/2/0/CODE_OF_CONDUCT.html). Al contribuir a este proyecto, aceptas cumplir con sus t茅rminos.

## Comenzar

### Para reportes automatizados

Despu茅s de la instalaci贸n e importaci贸n del paquete, puedes comenzar a usar `sivirep`:

```{r}
library(sivirep)
```

Revisa la lista de enfermedades disponibles para hacer un reporte con `sivirep` en:

```{r results = 'hide'}
list_events()
```

Actualmente, `sivirep` provee una plantilla de reporte llamada `Reporte B谩sico {sivirep}`, la cual contiene seis secciones y recibe los siguientes par谩metros de entrada: el nombre de la enfermedad, el a帽o, el nombre de departamento (opcional) y nombre del municipio (opcional) para descargar los datos de la fuente de SIVIGILA.

La plantilla se puede utilizar siguiendo los siguientes pasos:

1.  En RStudio hacer click *'File/New File/R'* Markdown:

![](man/figures/file_rmarkdown.png){.rmarkdown-img align="center" style="margin-left: 2.8em; margin-top: 0.8em; margin-bottom: 0.8em;"width="560"}

2.  Selecciona la opci贸n del panel izquierdo: *'From Template'*, despu茅s selecciona el template del reporte llamado `Reporte B谩sico {sivirep}`, indica el nombre que deseas para el reporte (i.e. Reporte_Laura), la ubicaci贸n donde deseas guardarlo y presiona *'Ok'*.

![](man/figures/reporte_basico.png){.rmarkdown-img align="center" style="margin-left: 2.8em; margin-top: 0.8em; margin-bottom: 0.8em;" width="550"}

3.  A continuaci贸n, podr谩s seleccionar el nombre de la enfermedad, el a帽o, el departamento (opcional) y el municipio (opcional) del reporte. Esta acci贸n descargar谩 los datos deseados y tambi茅n proporcionar谩 la plantilla en un archivo R Markdown (.Rmd). Para esto, es importante encontrar el bot贸n *'Knit'*, desplegar las opciones y seleccionar *'Knit with parameters'*.

![](man/figures/button_knit.png){.rmarkdown-img align="center" style="margin-left: 2.8em; margin-top: 0.8em; margin-bottom: 0.8em;" width="560"}

4. Espera unos segundos mientras el informe se genera en un archivo PDF.

5. Puedes agregar, editar, eliminar y personalizar las secciones del reporte en el archivo R Markdown generado anteriormente.

![](man/figures/editable_rmarkdown.png){.rmarkdown-img align="center" style="margin-left: 2.8em; margin-top: 0.8em; margin-bottom: 0.8em;" width="560"}

Para obtener m谩s detalles sobre plantillas y reportes gen茅ricos de R Markdown, por favor consulta [rmarkdown
templates](https://rstudio.github.io/rstudio-extensions/rmarkdown_templates.html).

## Para an谩lisis o reportes personalizados

Esta secci贸n proporciona un conjunto b谩sico de instrucciones para usar `sivirep`
0.0.2 si: 
- Ya has producido un archivo .Rmd y deseas editar un reporte.
- Deseas realizar an谩lisis personalizados sin un archivo .Rmd.

### 1. Importaci贸n de datos de SIVIGILA

La fuente de SIVIGILA proporciona los datos de la lista de casos hist贸ricos hasta el 煤ltimo a帽o epidemiol贸gico cerrado. El cierre de un a帽o epidemiol贸gico generalmente ocurre en abril del siguiente a帽o (por ejemplo, si est谩s utilizando `sivirep` en marzo de 2023, es posible que puedas acceder a los datos hist贸ricos hasta diciembre de 2021) para la mayor铆a de las enfermedades, con algunas excepciones.

Por favor, verifica las enfermedades y a帽os disponibles utilizando:

```{r results = 'hide'}
lista_eventos <- list_events()
```

Una vez que hayas decidido la enfermedad y el a帽o de la cual deseas obtener la informaci贸n, `import_data_event` es la funci贸n que permite la importaci贸n de datos desde la fuente de SIVIGILA utilizando un formato parametrizado basado en la enfermedad y el a帽o.

```{r}
data_event <-  import_data_event(year = 2020,
                                 nombre_event = "dengue")
```

#####  Tip 1 - Evita retrasos en el tiempo al importar los datos

- `sivirep` 0.0.2 est谩 dise帽ado para ayudar con el acceso a la fuente de SIVIGILA. Este proceso de descarga de informaci贸n puede tomar unos minutos dependiendo del tama帽o del conjunto de datos. Para evitar descargar los mismos datos repetidamente, puedes utilizar `cache = TRUE` en la funci贸n `import_data_event`. Esta opci贸n est谩 configurada de forma predeterminada.

### 2. Limpieza de datos de SIVIGILA

Los datos de SIVIGILA son una fuente de informaci贸n oficial altamente confiable, con certificaci贸n ISO de calidad de datos. Sin embargo, a veces puede haber algunos valores at铆picos en los datos que requieran una limpieza adicional.

`sivirep` proporciona una funci贸n gen茅rica llamada `limpiar_data_sivigila` que envuelve diversas tareas para identificar y corregir errores, inconsistencias y discrepancias en los conjuntos de datos con el fin de mejorar su calidad y precisi贸n. Este proceso puede incluir la eliminaci贸n de duplicados, la correcci贸n de errores tipogr谩ficos, el reemplazo de valores faltantes y la validaci贸n de datos, entre otras tareas, como eliminar fechas improbables, limpiar c贸digos de geolocalizaci贸n y estandarizar los nombres de las columnas y las categor铆as de edad.

```{r}
data_event_limp <- limpiar_data_sivigila(data_event = data_event, year = 2020)
```

Las funciones de limpieza dentro de `limpiar_data_sivigila` se han recopilado y creado en base a la experiencia de epidemi贸logos de campo. Estas pueden incluir funciones internas como:

- `limpiar_encabezado`: funci贸n que limpia y estandariza los nombres de las columnas de los datos de lista de casos de SIVIGILA bas谩ndose en el diccionario de datos de SIVIGILA.

- `limpiar_edad_event`: funci贸n que limpia las edades de los datos de lista de casos de SIVIGILA.

- `format_fecha`: funci贸n que da un formato espec铆fico a una fecha.

- `limpiar_fecha_event`: funci贸n que limpia las fechas de los datos de enfermedades.

- `limpiar_cods_dpto`: funci贸n que limpia los c贸digos geogr谩ficos de departamentos en los datos de enfermedades.

El usuario puede utilizar estas funciones individualmente o simplemente utilizar la funci贸n envolvente gen茅rica `limpiar_data_sivigila`.

### 3. Filtrar casos

`sivirep` proporciona una funci贸n que permite filtrar los datos de enfermedades por departamento o nombre del municipio llamada `geo_filtro`. Esto permite al usuario crear un informe a nivel subnacional, seleccionando casos espec铆ficos basados en la ubicaci贸n geogr谩fica.

```{r}
data_event_filtrada <- geo_filtro(data_event = data_event_limp,
                                  nombre_dpto = "Antioquia")
``` 

### 4. Distribuci贸n temporal de casos

En `sivirep`, la distribuci贸n temporal de casos se define por las variables de fecha de inicio de s铆ntomas y fecha de notificaci贸n. Para cada una de estas variables, existen funciones especializadas para agrupar los datos y generar los gr谩ficos.

#### 4.1. Agrupar los datos por fecha de inicio de s铆ntomas en la escala temporal deseada

Para generar la distribuci贸n de casos por fecha de inicio de s铆ntomas, es necesario agrupar los datos por estas variables. `sivirep` proporciona una funci贸n que permite esta agrupaci贸n llamada `agrupar_fecha_inisintomas`, en la cual puedes especificar la unidad de tiempo para agrupar estas fechas. Los valores permitidos para este par谩metro son: d铆a y mes.

```{r}
casos_ini_sintomas_dia <- agrupar_fecha_inisintomas(data_event =
                                                      data_event_limp,
                                                    tipo = "day")
casos_ini_sintomas_mes <- agrupar_fecha_inisintomas(data_event =
                                                      data_event_limp,
                                                    tipo = "month")
```

#####  Tip 2 - Obt茅n los primeros n meses con m谩s casos

- Al construir una secci贸n del reporte o analizar estos datos, puede ser 煤til obtener los meses con m谩s casos. En `sivirep`, puedes utilizar la funci贸n `obtener_meses_mas_casos` para obtener esta informaci贸n.

El gr谩fico que permite visualizar esta distribuci贸n se debe generar con la funci贸n `plot_fecha_inisintomas`. Ten en cuenta que, incluso si has agrupado los datos por d铆a, es posible que prefieras representarlo por mes, como en:

```{r fig.height = 4, fig.width = 7}
plot_fecha_inisintomas(data_agrupada = casos_ini_sintomas_dia,
                       uni_marca = "months")
```

#### 4.2. Agrupar los datos por fecha de notificaci贸n en la escala temporal deseada

El proceso para generar la distribuci贸n de casos por fecha de notificaci贸n consiste en agrupar los datos de enfermedades por esta variable. Puedes utilizar la siguiente funci贸n de `sivirep` para hacer esto:

```{r}
casos_fecha_notificacion_dia <- agrupar_fecha_notifica(data_event =
                                                         data_event_limp,
                                                       tipo = "day")
casos_fecha_notificacion_mes <- agrupar_fecha_notifica(data_event =
                                                         data_event_limp,
                                                       tipo = "month")
```

El gr谩fico que permite visualizar esta distribuci贸n debe generarse con la funci贸n `plot_fecha_notifica`. Ten en cuenta que, aunque hayas agrupado los datos por d铆a, es posible que prefieras representarlos por mes, como en:

```{r fig.height = 4, fig.width = 7}
plot_fecha_notifica(data_agrupada = casos_fecha_notificacion_dia,
                    uni_marca = "months")
```

### 5. Edad y sexo

### 5.1. Variable de sexo

Cuando se analizan o se informan datos de enfermedades, a menudo es necesario determinar la distribuci贸n de casos por g茅nero o sexo. Sin embargo, la fuente de SIVIGILA solo registra el sexo.

`sivirep` proporciona una funci贸n que agrega y calcula autom谩ticamente los porcentajes por sexo despu茅s del proceso de limpieza.

```{r}
casos_sex <- agrupar_sex(data_event = data_event_limp,
                         porcentaje = TRUE)
```

Adem谩s, `sivirep` cuenta con una funci贸n para generar el gr谩fico por esta variable llamada `plot_sex`:

```{r fig.height = 4, fig.width = 7}
plot_sex(data_agrupada = casos_sex)
```

La distribuci贸n de casos por sexo y semana epidemiol贸gica se puede generar utilizando la funci贸n `agrupar_sex_semanaepi` proporcionada por `sivirep`.

```{r}
casos_sex_semanaepi <- agrupar_sex_semanaepi(data_event = data_event_limp)
```

La funci贸n de visualizaci贸n correspondiente es `plot_sex_semanaepi`, que `sivirep` proporciona para mostrar la distribuci贸n de casos por sexo y semana epidemiol贸gica. 

```{r fig.height = 4, fig.width = 7}
plot_sex_semanaepi(data_agrupada = casos_sex_semanaepi)
```

### 5.2. Variable de edad

La edad es una variable importante para analizar, ya que es un factor de riesgo conocido para muchas enfermedades. Ciertas enfermedades y condiciones tienden a ocurrir con m谩s frecuencia en grupos de edad espec铆ficos, y esta distribuci贸n puede ayudar a identificar poblaciones con mayor riesgo e implementar estrategias de prevenci贸n y control dirigidas.

`sivirep` proporciona una funci贸n llamada `agrupar_edad`, que puede agrupar los datos de enfermedades por grupos de edad. De forma predeterminada, esta funci贸n produce rangos de edad con intervalos de 10 a帽os. Adem谩s, los usuarios pueden personalizar un rango de edad diferente.

```{r}
casos_edad <- agrupar_edad(data_event = data_event_limp, interval_edad = 10)
```

La funci贸n de visualizaci贸n correspondiente es `plot_edad`.

```{r fig.height = 4, fig.width = 7}
plot_edad(data_agrupada = casos_edad)
```

### 5.3. Edad y sexo simult谩neamente

`sivirep` proporciona una funci贸n llamada `agrupar_edad_sex`, que puede agrupar los datos de enfermedades por rangos de edad y sexo de forma simult谩nea y obtener el n煤mero de casos y los porcentajes correspondientes. Adem谩s, permite personalizar el intervalo de edad.

```{r}
casos_edad_sex <- agrupar_edad_sex(data_event = data_event_limp,
                                   interval_edad = 10)

```

La funci贸n de visualizaci贸n correspondiente es `plot_edad_sex`.

```{r fig.height = 3, fig.width = 7}
plot_edad_sex(data_agrupada = casos_edad_sex)
```

### 6. Distribuci贸n espacial de casos

Obtener la distribuci贸n espacial de los casos es 煤til para identificar 谩reas con una alta concentraci贸n de casos, agrupaciones de enfermedades y factores de riesgo ambientales o sociales.

En Colombia, existen 32 unidades geogr谩ficas administrativas (adm1) llamadas departamentos. `sivirep` proporciona una funci贸n llamada `agrupar_mun` que permite obtener un data.frame de casos agrupados por departamento o municipio.

```{r}
dist_esp_dept <- agrupar_mun(data_event = data_event_filtrada,
                             dept_nombre = "Antioquia")
```

Actualmente, con la funci贸n llamada `plot_map`, el usuario puede generar un mapa est谩tico de Colombia que muestra la distribuci贸n de casos por departamentos y municipios.

```{r fig.height = 7, fig.width = 7, results='hide', echo = FALSE}
mapa <- plot_map(data_agrupada = dist_esp_dept, dpto = "Antioquia")
```

```{r fig.height = 7, fig.width = 7}
mapa
```


#####  Tip 3 - Obt茅n la fila con m谩s casos

- Al construir una secci贸n del reporte o analizar estos datos, puede ser 煤til saber cu谩l es la variable que tiene la mayor铆a de los casos. En `sivirep`, puedes utilizar la funci贸n `obtener_fila_mas_casos` para obtener esta informaci贸n. Esta funci贸n funciona con cualquier conjunto de datos que contenga una columna llamada "casos" en cualquier nivel de agregaci贸n.
